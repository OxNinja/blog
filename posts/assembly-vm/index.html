<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>üîé Creating a VM for fun - Part 1: ASM | 0xNinja - My blog</title><meta name=keywords content="assembly,low-level,reverse"><meta name=description content="The first part of my series on low-level learning journey, sit back, relax and enjoy me struggling for basic stuff."><meta name=author content="0xNinja"><link rel=canonical href=https://0xninja.fr/posts/assembly-vm/><link crossorigin=anonymous href=/assets/css/stylesheet.min.00639c023f67c81a08cf1284873223d9b1f92ead1a4e7aa5649e77dcdd8a0e64.css integrity="sha256-AGOcAj9nyBoIzxKEhzIj2bH5Lq0aTnqlZJ533N2KDmQ=" rel="preload stylesheet" as=style><link rel=icon href=https://0xninja.fr/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://0xninja.fr/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://0xninja.fr/favicon-32x32.png><link rel=apple-touch-icon href=https://0xninja.fr/apple-touch-icon.png><link rel=mask-icon href=https://0xninja.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.82.0"><meta property="og:title" content="üîé Creating a VM for fun - Part 1: ASM"><meta property="og:description" content="The first part of my series on low-level learning journey, sit back, relax and enjoy me struggling for basic stuff."><meta property="og:type" content="article"><meta property="og:url" content="https://0xninja.fr/posts/assembly-vm/"><meta property="og:image" content="https://0xninja.fr/banner.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-17T10:39:42+02:00"><meta property="article:modified_time" content="2022-03-17T10:39:42+02:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://0xninja.fr/banner.png"><meta name=twitter:title content="üîé Creating a VM for fun - Part 1: ASM"><meta name=twitter:description content="The first part of my series on low-level learning journey, sit back, relax and enjoy me struggling for basic stuff."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://0xninja.fr/posts/"},{"@type":"ListItem","position":3,"name":"üîé Creating a VM for fun - Part 1: ASM","item":"https://0xninja.fr/posts/assembly-vm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"üîé Creating a VM for fun - Part 1: ASM","name":"üîé Creating a VM for fun - Part 1: ASM","description":"The first part of my series on low-level learning journey, sit back, relax and enjoy me struggling for basic stuff.","keywords":["assembly","low-level","reverse"],"articleBody":"To make things short, I saw How to write a virtual machine in order to hide your viruses and break your brain forever by @s01den published in tmp.out‚Äôs second edition. This new paper made me enjoy (once again) low-level. I wanted to know more about this abstract subject of ‚Äúvirtual machines‚Äù in reverse engineering, so I read it and started to implement my own VM in assembly!\n You will find my code on my Github repo\n Why assembly? I wanted to understand everything I did during this process, and needed to stick with the lowest level I could, I will talk about the future of this project at the end of the post.\nI was also already familiar with assembly, especially nasm for Linux, and wanted to test my knowledge.\nDesign Before staring to type very fast on my keyboard, I needed to put things on a paper, in order to have a clear overview of the project.\nI had to answer a few questions:\n  What is an instruction?\nIt‚Äôs like a function, or an alias to some code to execute\n  How does the CPU knows what to do with an instruction?\nThe code an instruction represents is written for the CPU, so it is seamless\n  How can I make custom instructions?\nJust implemet some functions or code blocks, then map them to a custom ‚ÄúOPcode‚Äù\n  How can I make the CPU execute my custom instructions?\nMake a simple condition on the custom OPcode, and execute the code mapped to it\n  PoC Registers To (re)set registers, code is very straightforward and don‚Äôt really need explainations, right?\nreset_registers: push rbp mov rbp, rsp xor rax, rax xor rbx, rbx xor rcx, rcx xor rdx, rdx xor r8, r8 leave ret Instructions I decided to implement a very low amount of instructions, as I already plan to upgrade this project in the future. I only need a proof of concept before going big.\n   OPcode Instruction NASM     0x1 mov a, b mov rbx, rcx    0x2 push a push rbx    0x3 add a, b add rbx, rcx    0x4 jmp a jmp rbx     Yes, some very basic instructions.\nExecution The concept here is to compare rax, our opcode register and then call the corresponding function:\n;; if opcode == 0x1: ;; mov_a_b() cmp rax, 0x1 je mov_a_b cmp rax, 0x2 je push_a cmp rax, 0x3 je add_a_b ;; and so on with every opcode call _exit ;; default if unrecognized opcode Future In a future post I will cover how to improve this VM, especially using a fully emulated virtual memory, using C. üòé\n","wordCount":"429","inLanguage":"en","image":"https://0xninja.fr/banner.png","datePublished":"2022-03-17T10:39:42+02:00","dateModified":"2022-03-17T10:39:42+02:00","author":{"@type":"Person","name":"0xNinja"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://0xninja.fr/posts/assembly-vm/"},"publisher":{"@type":"Organization","name":"0xNinja - My blog","logo":{"@type":"ImageObject","url":"https://0xninja.fr/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://0xninja.fr accesskey=h title="0xNinja - My blog (Alt + H)">0xNinja - My blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://0xninja.fr/about/ title="ü•∑ About"><span>ü•∑ About</span></a></li><li><a href=https://0xninja.fr/archives/ title="üìù Archives"><span>üìù Archives</span></a></li><li><a href=https://0xninja.fr/tags/ title="üè∑Ô∏è Tags"><span>üè∑Ô∏è Tags</span></a></li><li><a href=https://0xninja.fr/projects/ title="üî¨ Projects"><span>üî¨ Projects</span></a></li><li><a href=https://0xninja.fr/search/ title="üîé Search (Alt + /)" accesskey=/><span>üîé Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://0xninja.fr>Home</a>&nbsp;¬ª&nbsp;<a href=https://0xninja.fr/posts/>Posts</a></div><h1 class=post-title>üîé Creating a VM for fun - Part 1: ASM<div class=entry-isdraft><sup>&nbsp;&nbsp;[draft]</sup></div></h1><div class=post-meta>March 17, 2022&nbsp;¬∑&nbsp;3 min&nbsp;¬∑&nbsp;0xNinja</div></header><figure class=entry-cover><img loading=lazy srcset="https://0xninja.fr/posts/assembly-vm/banner_hu73eac952bfc52ed425ec634e0dc12903_80252_360x0_resize_box_2.png 360w ,https://0xninja.fr/posts/assembly-vm/banner_hu73eac952bfc52ed425ec634e0dc12903_80252_480x0_resize_box_2.png 480w ,https://0xninja.fr/posts/assembly-vm/banner_hu73eac952bfc52ed425ec634e0dc12903_80252_720x0_resize_box_2.png 720w ,https://0xninja.fr/posts/assembly-vm/banner_hu73eac952bfc52ed425ec634e0dc12903_80252_1080x0_resize_box_2.png 1080w ,https://0xninja.fr/posts/assembly-vm/banner.png 1377w" sizes="(min-width: 768px) 720px, 100vw" src=https://0xninja.fr/posts/assembly-vm/banner.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#why-assembly aria-label="Why assembly?">Why assembly?</a></li><li><a href=#design aria-label=Design>Design</a></li><li><a href=#poc aria-label=PoC>PoC</a><ul><li><a href=#registers aria-label=Registers>Registers</a></li><li><a href=#instructions aria-label=Instructions>Instructions</a></li><li><a href=#execution aria-label=Execution>Execution</a></li></ul></li><li><a href=#future aria-label=Future>Future</a></li></ul></div></details></div><div class=post-content><p>To make things short, I saw <a href=https://tmpout.sh/2/7.html>How to write a virtual machine in order to hide your viruses and break your brain forever</a> by <a href=https://twitter.com/s01den>@s01den</a> published in <a href=https://tmpout.sh>tmp.out</a>&rsquo;s second edition. This new paper made me enjoy (once again) low-level. I wanted to know more about this abstract subject of &ldquo;virtual machines&rdquo; in reverse engineering, so I read it and started to implement my own VM in assembly!</p><blockquote><p>You will find my code on <a href=https://github.com/OxNinja/nasm_/blob/main/vm/vm.asm>my Github repo</a></p></blockquote><h2 id=why-assembly>Why assembly?<a hidden class=anchor aria-hidden=true href=#why-assembly>#</a></h2><p>I wanted to understand everything I did during this process, and needed to stick with the lowest level I could, I will talk about the future of this project at the end of the post.</p><p>I was also already familiar with assembly, especially nasm for Linux, and wanted to test my knowledge.</p><h2 id=design>Design<a hidden class=anchor aria-hidden=true href=#design>#</a></h2><p>Before staring to type very fast on my keyboard, I needed to put things on a paper, in order to have a clear overview of the project.</p><p>I had to answer a few questions:</p><ul><li><p>What is an instruction?</p><p>It&rsquo;s like a function, or an alias to some code to execute</p></li><li><p>How does the CPU knows what to do with an instruction?</p><p>The code an instruction represents is written for the CPU, so it is seamless</p></li><li><p>How can I make custom instructions?</p><p>Just implemet some functions or code blocks, then map them to a custom &ldquo;OPcode&rdquo;</p></li><li><p>How can I make the CPU execute my custom instructions?</p><p>Make a simple condition on the custom OPcode, and execute the code mapped to it</p></li></ul><h2 id=poc>PoC<a hidden class=anchor aria-hidden=true href=#poc>#</a></h2><h3 id=registers>Registers<a hidden class=anchor aria-hidden=true href=#registers>#</a></h3><p>To (re)set registers, code is very straightforward and don&rsquo;t really need explainations, right?</p><pre><code class=language-assembly data-lang=assembly>reset_registers:
  push rbp
  mov rbp, rsp

  xor rax, rax
  xor rbx, rbx
  xor rcx, rcx
  xor rdx, rdx
  xor r8, r8

  leave
  ret
</code></pre><h3 id=instructions>Instructions<a hidden class=anchor aria-hidden=true href=#instructions>#</a></h3><p>I decided to implement a very low amount of instructions, as I already plan to upgrade this project in the future. I only need a proof of concept before going big.</p><table><thead><tr><th>OPcode</th><th>Instruction</th><th>NASM</th></tr></thead><tbody><tr><td><code>0x1</code></td><td><code>mov a, b</code></td><td><code>mov rbx, rcx</code></td></tr><tr><td><code>0x2</code></td><td><code>push a</code></td><td><code>push rbx</code></td></tr><tr><td><code>0x3</code></td><td><code>add a, b</code></td><td><code>add rbx, rcx</code></td></tr><tr><td><code>0x4</code></td><td><code>jmp a</code></td><td><code>jmp rbx</code></td></tr></tbody></table><p>Yes, some very basic instructions.</p><h3 id=execution>Execution<a hidden class=anchor aria-hidden=true href=#execution>#</a></h3><p>The concept here is to compare <code>rax</code>, our opcode register and then call the corresponding function:</p><pre><code class=language-assembly data-lang=assembly>;; if opcode == 0x1:
;;   mov_a_b()
cmp rax, 0x1
je mov_a_b

cmp rax, 0x2
je push_a

cmp rax, 0x3
je add_a_b

;; and so on with every opcode

call _exit ;; default if unrecognized opcode
</code></pre><h2 id=future>Future<a hidden class=anchor aria-hidden=true href=#future>#</a></h2><p>In a future post I will cover how to improve this VM, especially using a fully emulated virtual memory, using C. üòé</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://0xninja.fr/tags/assembly/>assembly</a></li><li><a href=https://0xninja.fr/tags/low-level/>low-level</a></li><li><a href=https://0xninja.fr/tags/reverse/>reverse</a></li></ul><nav class=paginav><a class=next href=https://0xninja.fr/posts/tldr-git/><span class=title>Next Page ¬ª</span><br><span>üöÄ TL;DR - Git</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://0xninja.fr>0xNinja - My blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>